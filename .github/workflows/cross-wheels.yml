name: Cross Wheel

on: [push, pull_request]

jobs:
  generate-stubs:
    name: Generate stubs
    runs-on: ubuntu-latest
    container: ghcr.io/tttapa/docker-cross-python:${{ matrix.triple }}-py${{ matrix.python-version }}-1.0.4
    strategy:
      matrix:
        triple: ['x86_64-centos7-linux-gnu']
        python-version: ['3.11']
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build
        uses: ./.github/workflows/python-build
        with:
          host: ${{ matrix.triple }}
          python-version: ${{ matrix.python-version }}
          export-stubs: stubs

      - name: Upload stubs
        uses: actions/upload-artifact@v3
        with:
          name: stubs
          retention-days: 1
          path: stubs.tar

  cross-build-wheels-linux:
    name: Cross-build wheels for ${{ matrix.triple }} - ${{ matrix.python-version }}
    needs: [generate-stubs]
    runs-on: ubuntu-latest
    container: ghcr.io/tttapa/docker-cross-python:${{ matrix.triple }}-py${{ matrix.python-version }}-1.0.4
    strategy:
      matrix:
        triple: ['x86_64-centos7-linux-gnu', 'aarch64-rpi3-linux-gnu']
        python-version: ['3.7', '3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download stubs
        uses: actions/download-artifact@v3
        with:
          name: stubs

      - name: Extract stubs
        run: tar xf stubs.tar

      - name: Build
        uses: ./.github/workflows/python-build
        with:
          host: ${{ matrix.triple }}
          python-version: ${{ matrix.python-version }}

      - name: Upload package
        uses: actions/upload-artifact@v3
        with:
          name: wheels-${{ matrix.triple }}
          path: ./dist/*.whl
